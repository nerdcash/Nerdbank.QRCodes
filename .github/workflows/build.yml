name: ğŸ­ Build

on:
  push:
    branches:
    - main
    - 'v*.*'
    - validate/*
  pull_request:
  workflow_dispatch:

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  BUILDCONFIGURATION: Release
  NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages/

jobs:
  build:
    name: ğŸ­ Build

    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
        - ubuntu-24.04
        - macOS-15
        - windows-2025

    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        fetch-depth: 0 # avoid shallow clone so nbgv can do its work.
    - name: âš™ Install prerequisites
      run: |
        ./init.ps1 -UpgradePrerequisites
        dotnet --info

        # Print mono version if it is present.
        if (Get-Command mono -ErrorAction SilentlyContinue) {
          mono --version
        }
      shell: pwsh
    - name: âš™ï¸ Set pipeline variables based on source
      run: tools/variables/_define.ps1
      shell: pwsh
    - name: ğŸ› ï¸ cargo build
      run: src/nerdbank-qrcodes/build_all.ps1 -Release
      shell: pwsh
      env:
        IPHONEOS_DEPLOYMENT_TARGET: 17.0

    - uses: taiki-e/install-action@v2
      with:
        tool: cross
      if: startsWith(matrix.os, 'ubuntu')
      name: âš™ï¸ cargo install cross

    - name: ğŸ› ï¸ cross build linux-arm64
      run: cross build -r --target=aarch64-unknown-linux-gnu
      shell: pwsh
      if: startsWith(matrix.os, 'ubuntu')
      working-directory: src/nerdbank-qrcodes

    - name: ğŸ“± Build iOS Framework
      run: azure-pipelines/build_ios_framework.ps1
      shell: pwsh
      if: startsWith(matrix.os, 'macos')

    - name: ğŸ›  dotnet build
      run: |
        dotnet build -p:Platform=x64 --no-restore -c ${{ env.BUILDCONFIGURATION }} -warnAsError -warnNotAsError:NU1901,NU1902,NU1903,NU1904 /bl:"${{ runner.temp }}/_artifacts/build_logs/build_x64.binlog"
        dotnet build -p:Platform=ARM64 --no-restore -c ${{ env.BUILDCONFIGURATION }} -warnAsError -warnNotAsError:NU1901,NU1902,NU1903,NU1904 /bl:"${{ runner.temp }}/_artifacts/build_logs/build_arm64.binlog"
    - name: ğŸ§ª dotnet test
      run: tools/dotnet-test-cloud.ps1 -Configuration ${{ env.BUILDCONFIGURATION }} -Agent ${{ runner.os }}
      shell: pwsh
    - name: ğŸ’…ğŸ» Verify formatted code
      run: dotnet format --verify-no-changes --no-restore
      shell: pwsh
      if: runner.os == 'Linux'
    - name: ğŸ“š Verify docfx build
      run: dotnet docfx docfx/docfx.json --warningsAsErrors --disableGitFeatures
      if: runner.os == 'Linux'
    - name: âš™ Update pipeline variables based on build outputs
      run: tools/variables/_define.ps1
      shell: pwsh
    - name: ğŸ“¢ Publish artifacts
      uses: ./.github/actions/publish-artifacts
      if: cancelled() == false
    - name: ğŸ“¢ Publish code coverage results to codecov.io
      run: |
        if ('${{ secrets.CODECOV_TOKEN }}') {
          ./tools/publish-CodeCov.ps1 -CodeCovToken '${{ secrets.CODECOV_TOKEN }}' -PathToCodeCoverage "${{ runner.temp }}/_artifacts/coverageResults" -Name "${{ runner.os }} Coverage Results" -Flags "${{ runner.os }}"
        }
      shell: pwsh
      timeout-minutes: 3
      continue-on-error: true
      if: always()

  android:
    name: ğŸ¤– Android

    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0 # avoid shallow clone so nbgv can do its work.
    - uses: taiki-e/install-action@v2
      with:
        tool: cargo-ndk@3
      name: âš™ï¸ Install cargo-ndk
    - name: âš™ï¸ install android tooling
      run: ./tools/Install-AndroidBuildTools.ps1
      shell: pwsh
    - run: ./build_all.ps1 -AndroidEmulatorOnly -AndroidDeviceOnly -Release
      name: ğŸ› ï¸ build android
      working-directory:  src/nerdbank-qrcodes
      shell: pwsh
    - name: ğŸ“¥ Collect artifacts
      run: tools/artifacts/_stage_all.ps1
      shell: pwsh
      if: always()
    - name: ğŸ“¢ Upload rust
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: rust-android
        path: ${{ runner.temp }}/_artifacts/rust

  pack:
    name: ğŸ“¦ Pack

    needs:
    - build
    - android
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0 # avoid shallow clone so nbgv can do its work.

    - name: âš™ Install prerequisites
      run: |
        ./init.ps1 -UpgradePrerequisites
        dotnet --info

        # Print mono version if it is present.
        if (Get-Command mono -ErrorAction SilentlyContinue) {
          mono --version
        }
      shell: pwsh

    - uses: taiki-e/install-action@v2
      with:
        tool: cargo-bundle-licenses
      name: âš™ï¸ Install cargo-bundle-licenses

    - name: ğŸªª 3rd party licenses
      run: src/nerdbank-qrcodes/Generate-3rdPartyNotices.ps1
      shell: pwsh

    - name: ğŸ”» Download linux artifacts
      uses: actions/download-artifact@v4
      with:
        name: rust-Linux
        path: src/nerdbank-qrcodes/target

    - name: ğŸ”» Download android artifacts
      uses: actions/download-artifact@v4
      with:
        name: rust-android
        path: src/nerdbank-qrcodes/target

    - name: ğŸ”» Download windows artifacts
      uses: actions/download-artifact@v4
      with:
        name: rust-Windows
        path: src/nerdbank-qrcodes/target

    - name: ğŸ”» Download macOS artifacts
      uses: actions/download-artifact@v4
      with:
        name: rust-macOS
        path: src/nerdbank-qrcodes/target

    - name: ğŸ”» Download iOS framework
      uses: actions/download-artifact@v4
      with:
        name: ios_framework
        path: bin/release/nerdbank_qrcodes.xcframework

    - name: ğŸ›  dotnet pack
      run: dotnet pack --no-restore -c ${{ env.BUILDCONFIGURATION }} -warnAsError -warnNotAsError:NU1901,NU1902,NU1903,NU1904 /bl:"${{ runner.temp }}/_artifacts/build_logs/build.binlog"

    - name: ğŸ“¥ Collect artifacts
      run: tools/artifacts/_stage_all.ps1
      shell: pwsh
      if: always()

    - name: ğŸ“¢ Upload deployables
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: deployables
        path: ${{ runner.temp }}/_artifacts/deployables
      if: always()

  docs:
    name: ğŸ“ƒ Docs
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
    - name: ğŸ”— Markup Link Checker (mlc)
      uses: becheran/mlc@18a06b3aa2901ca197de59c8b0b1f54fdba6b3fa # v1.0.0
      with:
        args: --do-not-warn-for-redirect-to https://learn.microsoft.com*,https://dotnet.microsoft.com/*,https://dev.azure.com/*,https://app.codecov.io/* -p docfx -i https://www.npmjs.com/package/*,https://get.dot.net/
